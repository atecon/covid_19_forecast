clear
set verbose off

# SETTINGS
#==========
#string DIR_WORK = <SET_PATH_HERE>		# e.g. "/home/git_project"
string DIR_WORK = "/home/at/git/covid_19_forecast"
string DATA_URL = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv"
string INITIAL_DATE = "2020-01-22"			# 1st observation of dataset
scalar MAX_HORIZON = 7			# multi-step OoS forecast horizon
#===================

set workdir @DIR_WORK

# include helper functions
include "./src/helper.inp"
# 3rd party library
pkg install mat2data
include mat2data.gfn


# Download raw csv data and process its header
string data_raw = download_current_csv_as_str(DATA_URL)
string data_processed = process_date_header(data_raw)
string filename = data_string_to_file(data_processed)

# Open processed data
open @filename --preserve --quiet

strings countries = get_country_names(CountryRegion)
print_countries(countries)

/*
list date_series = date_*
matrix dates = get_dates(date_series)
printf "\nInfo: First observation: %d\n Last observation: %d", min(dates), max(dates)
*/

# take sum across regions for each day -- construct time-series
list data_values = date_*
string filename = aggregate_data_and_store_csv(data_values)

# Load time-series + plot
open @filename --preserve --quiet
setobs 7 @INITIAL_DATE --time-series
gnuplot cases_confirmed non_zero_regions \
  --time-series --with-lines --output=display


# Expost analysis + plot multistep  interval forecasts
# ARIMA(2,0,1)
arima_forecast(cases_confirmed, , 2, 0, 0, MAX_HORIZON)

# ARIMA(2,1,1)
arima_forecast(cases_confirmed, , 2, 1, 1, MAX_HORIZON)

# Add future dates
dataset addobs MAX_HORIZON
# ARIMA(2,0,1)
arima_forecast(cases_confirmed, , 2, 0, 1, MAX_HORIZON)
# ARIMA(2,1,1)
arima_forecast(cases_confirmed, , 2, 1, 1, MAX_HORIZON)




